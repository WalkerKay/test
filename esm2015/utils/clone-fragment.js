import Base64 from 'slate-base64-serializer';
import Plain from 'slate-plain-serializer';
import getWindow from 'get-window';
import { IS_IE } from 'slate-dev-environment';
import { Value } from 'slate';
import TRANSFER_TYPES from '../constants/transfer-types';
import removeAllRanges from './remove-all-ranges';
import DATA_ATTRS from '../constants/data-attributes';
import SELECTORS from '../constants/selectors';
const { FRAGMENT, HTML, TEXT } = TRANSFER_TYPES;
function cloneFragment(event, editor, callback = () => undefined) {
    const window = getWindow(event.target);
    const native = window.getSelection();
    const { value } = editor;
    const { document, fragment, selection } = value;
    const { start, end } = selection;
    const startVoid = document.getClosestVoid(start.path, editor);
    const endVoid = document.getClosestVoid(end.path, editor);
    // If the selection is collapsed, and it isn't inside a void node, abort.
    if (native.isCollapsed && !startVoid) {
        return;
    }
    // Create a fake selection so that we can add a Base64-encoded copy of the
    // fragment to the HTML, to decode on future pastes.
    const encoded = Base64.serializeNode(fragment);
    const range = native.getRangeAt(0);
    let contents = range.cloneContents();
    let attach = contents.childNodes[0];
    // Make sure attach is a non-empty node, since empty nodes will not get copied
    contents.childNodes.forEach(node => {
        if (node.textContent && node.textContent.trim() !== '') {
            attach = node;
        }
    });
    // COMPAT: If the end node is a void node, we need to move the end of the
    // range from the void node's spacer span, to the end of the void node's
    // content, since the spacer is before void's content in the DOM.
    if (endVoid) {
        const r = range.cloneRange();
        const node = editor.findDOMNode(document.getPath(endVoid));
        r.setEndAfter(node);
        contents = r.cloneContents();
    }
    // COMPAT: If the start node is a void node, we need to attach the encoded
    // fragment to the void node's content node instead of the spacer, because
    // attaching it to empty `<div>/<span>` nodes will end up having it erased by
    // most browsers. (2018/04/27)
    if (startVoid) {
        attach = contents.childNodes[0].childNodes[1].firstChild;
    }
    // Remove any zero-width space spans from the cloned DOM so that they don't
    // show up elsewhere when pasted.
    [].slice.call(contents.querySelectorAll(SELECTORS.ZERO_WIDTH)).forEach(zw => {
        const isNewline = zw.getAttribute(DATA_ATTRS.ZERO_WIDTH) === 'n';
        zw.textContent = isNewline ? '\n' : '';
    });
    // Set a `data-slate-fragment` attribute on a non-empty node, so it shows up
    // in the HTML, and can be used for intra-Slate pasting. If it's a text
    // node, wrap it in a `<span>` so we have something to set an attribute on.
    if (attach.nodeType === 3) {
        const span = window.document.createElement('span');
        // COMPAT: In Chrome and Safari, if we don't add the `white-space` style
        // then leading and trailing spaces will be ignored. (2017/09/21)
        span.style.whiteSpace = 'pre';
        span.appendChild(attach);
        contents.appendChild(span);
        attach = span;
    }
    attach.setAttribute(DATA_ATTRS.FRAGMENT, encoded);
    //  Creates value from only the selected blocks
    //  Then gets plaintext for clipboard with proper linebreaks for BLOCK elements
    //  Via Plain serializer
    const valFromSelection = Value.create({ document: fragment });
    const plainText = Plain.serialize(valFromSelection);
    // Add the phony content to a div element. This is needed to copy the
    // contents into the html clipboard register.
    const div = window.document.createElement('div');
    div.appendChild(contents);
    // For browsers supporting it, we set the clipboard registers manually,
    // since the result is more predictable.
    // COMPAT: IE supports the setData method, but only in restricted sense.
    // IE doesn't support arbitrary MIME types or common ones like 'text/plain';
    // it only accepts "Text" (which gets mapped to 'text/plain') and "Url"
    // (mapped to 'text/url-list'); so, we should only enter block if !IS_IE
    if (event.clipboardData && event.clipboardData.setData && !IS_IE) {
        event.preventDefault();
        event.clipboardData.setData(TEXT, plainText);
        event.clipboardData.setData(FRAGMENT, encoded);
        event.clipboardData.setData(HTML, div.innerHTML);
        callback();
        return;
    }
    // COMPAT: For browser that don't support the Clipboard API's setData method,
    // we must rely on the browser to natively copy what's selected.
    // So we add the div (containing our content) to the DOM, and select it.
    const editorEl = event.target.closest(SELECTORS.EDITOR);
    div.setAttribute('contenteditable', true);
    div.style.position = 'absolute';
    div.style.left = '-9999px';
    editorEl.appendChild(div);
    native.selectAllChildren(div);
    // Revert to the previous selection right after copying.
    window.requestAnimationFrame(() => {
        editorEl.removeChild(div);
        removeAllRanges(native);
        native.addRange(range);
        callback();
    });
}
export default cloneFragment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xvbmUtZnJhZ21lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LXNsYXRlL2NvcmUvIiwic291cmNlcyI6WyJ1dGlscy9jbG9uZS1mcmFnbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE1BQU0sTUFBTSx5QkFBeUIsQ0FBQztBQUM3QyxPQUFPLEtBQUssTUFBTSx3QkFBd0IsQ0FBQztBQUMzQyxPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFFOUIsT0FBTyxjQUFjLE1BQU0sNkJBQTZCLENBQUM7QUFDekQsT0FBTyxlQUFlLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxVQUFVLE1BQU0sOEJBQThCLENBQUM7QUFDdEQsT0FBTyxTQUFTLE1BQU0sd0JBQXdCLENBQUM7QUFFL0MsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsY0FBYyxDQUFDO0FBRWhELFNBQVMsYUFBYSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsUUFBUSxHQUFHLEdBQUcsRUFBRSxDQUFDLFNBQVM7SUFFNUQsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDckMsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0sQ0FBQztJQUN6QixNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDaEQsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUM7SUFDakMsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE1B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QUFHLFNBQVMsQ0FBQztJQUMzQixRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUU5Qix3REFBd0Q7SUFDeEQsTUFBTSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsRUFBRTtRQUM5QixRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN4QixNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZCLFFBQVEsRUFBRSxDQUFDO0lBQ2YsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsZUFBZSxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmFzZTY0IGZyb20gJ3NsYXRlLWJhc2U2NC1zZXJpYWxpemVyJztcbmltcG9ydCBQbGFpbiBmcm9tICdzbGF0ZS1wbGFpbi1zZXJpYWxpemVyJztcbmltcG9ydCBnZXRXaW5kb3cgZnJvbSAnZ2V0LXdpbmRvdyc7XG5pbXBvcnQgeyBJU19JRSB9IGZyb20gJ3NsYXRlLWRldi1lbnZpcm9ubWVudCc7XG5pbXBvcnQgeyBWYWx1ZSB9IGZyb20gJ3NsYXRlJztcblxuaW1wb3J0IFRSQU5TRkVSX1RZUEVTIGZyb20gJy4uL2NvbnN0YW50cy90cmFuc2Zlci10eXBlcyc7XG5pbXBvcnQgcmVtb3ZlQWxsUmFuZ2VzIGZyb20gJy4vcmVtb3ZlLWFsbC1yYW5nZXMnO1xuaW1wb3J0IGZpbmRET01Ob2RlIGZyb20gJy4vZmluZC1kb20tbm9kZSc7XG5pbXBvcnQgREFUQV9BVFRSUyBmcm9tICcuLi9jb25zdGFudHMvZGF0YS1hdHRyaWJ1dGVzJztcbmltcG9ydCBTRUxFQ1RPUlMgZnJvbSAnLi4vY29uc3RhbnRzL3NlbGVjdG9ycyc7XG5cbmNvbnN0IHsgRlJBR01FTlQsIEhUTUwsIFRFWFQgfSA9IFRSQU5TRkVSX1RZUEVTO1xuXG5mdW5jdGlvbiBjbG9uZUZyYWdtZW50KGV2ZW50LCBlZGl0b3IsIGNhbGxiYWNrID0gKCkgPT4gdW5kZWZpbmVkKSB7XG5cbiAgICBjb25zdCB3aW5kb3cgPSBnZXRXaW5kb3coZXZlbnQudGFyZ2V0KTtcbiAgICBjb25zdCBuYXRpdmUgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7XG4gICAgY29uc3QgeyB2YWx1ZSB9ID0gZWRpdG9yO1xuICAgIGNvbnN0IHsgZG9jdW1lbnQsIGZyYWdtZW50LCBzZWxlY3Rpb24gfSA9IHZhbHVlO1xuICAgIGNvbnN0IHsgc3RhcnQsIGVuZCB9ID0gc2VsZWN0aW9uO1xuICAgIGNvbnN0IHN0YXJ0Vm9pZCA9IGRvY3VtZW50LmdldENsb3Nlc3RWb2lkKHN0YXJ0LnBhdGgsIGVkaXRvcik7XG4gICAgY29uc3QgZW5kVm9pZCA9IGRvY3VtZW50LmdldENsb3Nlc3RWb2lkKGVuZC5wYXRoLCBlZGl0b3IpO1xuXG4gICAgLy8gSWYgdGhlIHNlbGVjdGlvbiBpcyBjb2xsYXBzZWQsIGFuZCBpdCBpc24ndCBpbnNpZGUgYSB2b2lkIG5vZGUsIGFib3J0LlxuICAgIGlmIChuYXRpdmUuaXNDb2xsYXBzZWQgJiYgIXN0YXJ0Vm9pZCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGEgZmFrZSBzZWxlY3Rpb24gc28gdGhhdCB3ZSBjYW4gYWRkIGEgQmFzZTY0LWVuY29kZWQgY29weSBvZiB0aGVcbiAgICAvLyBmcmFnbWVudCB0byB0aGUgSFRNTCwgdG8gZGVjb2RlIG9uIGZ1dHVyZSBwYXN0ZXMuXG4gICAgY29uc3QgZW5jb2RlZCA9IEJhc2U2NC5zZXJpYWxpemVOb2RlKGZyYWdtZW50KTtcbiAgICBjb25zdCByYW5nZSA9IG5hdGl2ZS5nZXRSYW5nZUF0KDApO1xuICAgIGxldCBjb250ZW50cyA9IHJhbmdlLmNsb25lQ29udGVudHMoKTtcbiAgICBsZXQgYXR0YWNoID0gY29udGVudHMuY2hpbGROb2Rlc1swXTtcblxuICAgIC8vIE1ha2Ugc3VyZSBhdHRhY2ggaXMgYSBub24tZW1wdHkgbm9kZSwgc2luY2UgZW1wdHkgbm9kZXMgd2lsbCBub3QgZ2V0IGNvcGllZFxuICAgIGNvbnRlbnRzLmNoaWxkTm9kZXMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgaWYgKG5vZGUudGV4dENvbnRlbnQgJiYgbm9kZS50ZXh0Q29udGVudC50cmltKCkgIT09ICcnKSB7XG4gICAgICAgICAgICBhdHRhY2ggPSBub2RlO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBDT01QQVQ6IElmIHRoZSBlbmQgbm9kZSBpcyBhIHZvaWQgbm9kZSwgd2UgbmVlZCB0byBtb3ZlIHRoZSBlbmQgb2YgdGhlXG4gICAgLy8gcmFuZ2UgZnJvbSB0aGUgdm9pZCBub2RlJ3Mgc3BhY2VyIHNwYW4sIHRvIHRoZSBlbmQgb2YgdGhlIHZvaWQgbm9kZSdzXG4gICAgLy8gY29udGVudCwgc2luY2UgdGhlIHNwYWNlciBpcyBiZWZvcmUgdm9pZCdzIGNvbnRlbnQgaW4gdGhlIERPTS5cbiAgICBpZiAoZW5kVm9pZCkge1xuICAgICAgICBjb25zdCByID0gcmFuZ2UuY2xvbmVSYW5nZSgpO1xuICAgICAgICBjb25zdCBub2RlID0gZWRpdG9yLmZpbmRET01Ob2RlKGRvY3VtZW50LmdldFBhdGgoZW5kVm9pZCkpO1xuICAgICAgICByLnNldEVuZEFmdGVyKG5vZGUpO1xuICAgICAgICBjb250ZW50cyA9IHIuY2xvbmVDb250ZW50cygpO1xuICAgIH1cblxuICAgIC8vIENPTVBBVDogSWYgdGhlIHN0YXJ0IG5vZGUgaXMgYSB2b2lkIG5vZGUsIHdlIG5lZWQgdG8gYXR0YWNoIHRoZSBlbmNvZGVkXG4gICAgLy8gZnJhZ21lbnQgdG8gdGhlIHZvaWQgbm9kZSdzIGNvbnRlbnQgbm9kZSBpbnN0ZWFkIG9mIHRoZSBzcGFjZXIsIGJlY2F1c2VcbiAgICAvLyBhdHRhY2hpbmcgaXQgdG8gZW1wdHkgYDxkaXY+LzxzcGFuPmAgbm9kZXMgd2lsbCBlbmQgdXAgaGF2aW5nIGl0IGVyYXNlZCBieVxuICAgIC8vIG1vc3QgYnJvd3NlcnMuICgyMDE4LzA0LzI3KVxuICAgIGlmIChzdGFydFZvaWQpIHtcbiAgICAgICAgYXR0YWNoID0gY29udGVudHMuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLmZpcnN0Q2hpbGQ7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlIGFueSB6ZXJvLXdpZHRoIHNwYWNlIHNwYW5zIGZyb20gdGhlIGNsb25lZCBET00gc28gdGhhdCB0aGV5IGRvbid0XG4gICAgLy8gc2hvdyB1cCBlbHNld2hlcmUgd2hlbiBwYXN0ZWQuXG4gICAgW10uc2xpY2UuY2FsbChjb250ZW50cy5xdWVyeVNlbGVjdG9yQWxsKFNFTEVDVE9SUy5aRVJPX1dJRFRIKSkuZm9yRWFjaCh6dyA9PiB7XG4gICAgICAgIGNvbnN0IGlzTmV3bGluZSA9IHp3LmdldEF0dHJpYnV0ZShEQVRBX0FUVFJTLlpFUk9fV0lEVEgpID09PSAnbic7XG4gICAgICAgIHp3LnRleHRDb250ZW50ID0gaXNOZXdsaW5lID8gJ1xcbicgOiAnJztcbiAgICB9KTtcblxuICAgIC8vIFNldCBhIGBkYXRhLXNsYXRlLWZyYWdtZW50YCBhdHRyaWJ1dGUgb24gYSBub24tZW1wdHkgbm9kZSwgc28gaXQgc2hvd3MgdXBcbiAgICAvLyBpbiB0aGUgSFRNTCwgYW5kIGNhbiBiZSB1c2VkIGZvciBpbnRyYS1TbGF0ZSBwYXN0aW5nLiBJZiBpdCdzIGEgdGV4dFxuICAgIC8vIG5vZGUsIHdyYXAgaXQgaW4gYSBgPHNwYW4+YCBzbyB3ZSBoYXZlIHNvbWV0aGluZyB0byBzZXQgYW4gYXR0cmlidXRlIG9uLlxuICAgIGlmIChhdHRhY2gubm9kZVR5cGUgPT09IDMpIHtcbiAgICAgICAgY29uc3Qgc3BhbiA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG5cbiAgICAgICAgLy8gQ09NUEFUOiBJbiBDaHJvbWUgYW5kIFNhZmFyaSwgaWYgd2UgZG9uJ3QgYWRkIHRoZSBgd2hpdGUtc3BhY2VgIHN0eWxlXG4gICAgICAgIC8vIHRoZW4gbGVhZGluZyBhbmQgdHJhaWxpbmcgc3BhY2VzIHdpbGwgYmUgaWdub3JlZC4gKDIwMTcvMDkvMjEpXG4gICAgICAgIHNwYW4uc3R5bGUud2hpdGVTcGFjZSA9ICdwcmUnO1xuXG4gICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQoYXR0YWNoKTtcbiAgICAgICAgY29udGVudHMuYXBwZW5kQ2hpbGQoc3Bhbik7XG4gICAgICAgIGF0dGFjaCA9IHNwYW47XG4gICAgfVxuXG4gICAgYXR0YWNoLnNldEF0dHJpYnV0ZShEQVRBX0FUVFJTLkZSQUdNRU5ULCBlbmNvZGVkKTtcblxuICAgIC8vICBDcmVhdGVzIHZhbHVlIGZyb20gb25seSB0aGUgc2VsZWN0ZWQgYmxvY2tzXG4gICAgLy8gIFRoZW4gZ2V0cyBwbGFpbnRleHQgZm9yIGNsaXBib2FyZCB3aXRoIHByb3BlciBsaW5lYnJlYWtzIGZvciBCTE9DSyBlbGVtZW50c1xuICAgIC8vICBWaWEgUGxhaW4gc2VyaWFsaXplclxuICAgIGNvbnN0IHZhbEZyb21TZWxlY3Rpb24gPSBWYWx1ZS5jcmVhdGUoeyBkb2N1bWVudDogZnJhZ21lbnQgfSk7XG4gICAgY29uc3QgcGxhaW5UZXh0ID0gUGxhaW4uc2VyaWFsaXplKHZhbEZyb21TZWxlY3Rpb24pO1xuXG4gICAgLy8gQWRkIHRoZSBwaG9ueSBjb250ZW50IHRvIGEgZGl2IGVsZW1lbnQuIFRoaXMgaXMgbmVlZGVkIHRvIGNvcHkgdGhlXG4gICAgLy8gY29udGVudHMgaW50byB0aGUgaHRtbCBjbGlwYm9hcmQgcmVnaXN0ZXIuXG4gICAgY29uc3QgZGl2ID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGRpdi5hcHBlbmRDaGlsZChjb250ZW50cyk7XG5cbiAgICAvLyBGb3IgYnJvd3NlcnMgc3VwcG9ydGluZyBpdCwgd2Ugc2V0IHRoZSBjbGlwYm9hcmQgcmVnaXN0ZXJzIG1hbnVhbGx5LFxuICAgIC8vIHNpbmNlIHRoZSByZXN1bHQgaXMgbW9yZSBwcmVkaWN0YWJsZS5cbiAgICAvLyBDT01QQVQ6IElFIHN1cHBvcnRzIHRoZSBzZXREYXRhIG1ldGhvZCwgYnV0IG9ubHkgaW4gcmVzdHJpY3RlZCBzZW5zZS5cbiAgICAvLyBJRSBkb2Vzbid0IHN1cHBvcnQgYXJiaXRyYXJ5IE1JTUUgdHlwZXMgb3IgY29tbW9uIG9uZXMgbGlrZSAndGV4dC9wbGFpbic7XG4gICAgLy8gaXQgb25seSBhY2NlcHRzIFwiVGV4dFwiICh3aGljaCBnZXRzIG1hcHBlZCB0byAndGV4dC9wbGFpbicpIGFuZCBcIlVybFwiXG4gICAgLy8gKG1hcHBlZCB0byAndGV4dC91cmwtbGlzdCcpOyBzbywgd2Ugc2hvdWxkIG9ubHkgZW50ZXIgYmxvY2sgaWYgIUlTX0lFXG4gICAgaWYgKGV2ZW50LmNsaXBib2FyZERhdGEgJiYgZXZlbnQuY2xpcGJvYXJkRGF0YS5zZXREYXRhICYmICFJU19JRSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldmVudC5jbGlwYm9hcmREYXRhLnNldERhdGEoVEVYVCwgcGxhaW5UZXh0KTtcbiAgICAgICAgZXZlbnQuY2xpcGJvYXJkRGF0YS5zZXREYXRhKEZSQUdNRU5ULCBlbmNvZGVkKTtcbiAgICAgICAgZXZlbnQuY2xpcGJvYXJkRGF0YS5zZXREYXRhKEhUTUwsIGRpdi5pbm5lckhUTUwpO1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ09NUEFUOiBGb3IgYnJvd3NlciB0aGF0IGRvbid0IHN1cHBvcnQgdGhlIENsaXBib2FyZCBBUEkncyBzZXREYXRhIG1ldGhvZCxcbiAgICAvLyB3ZSBtdXN0IHJlbHkgb24gdGhlIGJyb3dzZXIgdG8gbmF0aXZlbHkgY29weSB3aGF0J3Mgc2VsZWN0ZWQuXG4gICAgLy8gU28gd2UgYWRkIHRoZSBkaXYgKGNvbnRhaW5pbmcgb3VyIGNvbnRlbnQpIHRvIHRoZSBET00sIGFuZCBzZWxlY3QgaXQuXG4gICAgY29uc3QgZWRpdG9yRWwgPSBldmVudC50YXJnZXQuY2xvc2VzdChTRUxFQ1RPUlMuRURJVE9SKTtcbiAgICBkaXYuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCB0cnVlKTtcbiAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuICAgIGRpdi5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnO1xuICAgIGVkaXRvckVsLmFwcGVuZENoaWxkKGRpdik7XG4gICAgbmF0aXZlLnNlbGVjdEFsbENoaWxkcmVuKGRpdik7XG5cbiAgICAvLyBSZXZlcnQgdG8gdGhlIHByZXZpb3VzIHNlbGVjdGlvbiByaWdodCBhZnRlciBjb3B5aW5nLlxuICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICBlZGl0b3JFbC5yZW1vdmVDaGlsZChkaXYpO1xuICAgICAgICByZW1vdmVBbGxSYW5nZXMobmF0aXZlKTtcbiAgICAgICAgbmF0aXZlLmFkZFJhbmdlKHJhbmdlKTtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xvbmVGcmFnbWVudDtcbiJdfQ==