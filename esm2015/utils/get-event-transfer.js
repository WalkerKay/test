import Base64 from 'slate-base64-serializer';
import { IS_IE } from 'slate-dev-environment';
import TRANSFER_TYPES from '../constants/transfer-types';
import DATA_ATTRS from '../constants/data-attributes';
/**
 * Transfer types.
 *
 * @type {String}
 */
const { FRAGMENT, HTML, NODE, RICH, TEXT } = TRANSFER_TYPES;
/**
 * Fragment matching regexp for HTML nodes.
 *
 * @type {RegExp}
 */
const FRAGMENT_MATCHER = / data-slate-fragment="([^\s"]+)"/;
/**
 * Get the transfer data from an `event`.
 *
 * @param {Event} event
 * @return {Object}
 */
function getEventTransfer(event) {
    // COMPAT: IE 11 doesn't populate nativeEvent with either
    // dataTransfer or clipboardData. We'll need to use the base event
    // object (2018/14/6)
    if (!IS_IE && event.nativeEvent) {
        event = event.nativeEvent;
    }
    const transfer = event.dataTransfer || event.clipboardData;
    let fragment = getType(transfer, FRAGMENT);
    let node = getType(transfer, NODE);
    const html = getType(transfer, HTML);
    const rich = getType(transfer, RICH);
    let text = getType(transfer, TEXT);
    let files;
    // If there isn't a fragment, but there is HTML, check to see if the HTML is
    // actually an encoded fragment.
    // tslint:disable-next-line:no-bitwise
    if (!fragment && html && ~html.indexOf(` ${DATA_ATTRS.FRAGMENT}="`)) {
        const matches = FRAGMENT_MATCHER.exec(html);
        const [full, encoded] = matches; // eslint-disable-line no-unused-vars
        if (encoded) {
            fragment = encoded;
        }
    }
    // COMPAT: Edge doesn't handle custom data types
    // These will be embedded in text/plain in this case (2017/7/12)
    if (text) {
        const embeddedTypes = getEmbeddedTypes(text);
        if (embeddedTypes[FRAGMENT]) {
            fragment = embeddedTypes[FRAGMENT];
        }
        if (embeddedTypes[NODE]) {
            node = embeddedTypes[NODE];
        }
        if (embeddedTypes[TEXT]) {
            text = embeddedTypes[TEXT];
        }
    }
    // Decode a fragment or node if they exist.
    if (fragment) {
        fragment = Base64.deserializeNode(fragment);
    }
    if (node) {
        node = Base64.deserializeNode(node);
    }
    // COMPAT: Edge sometimes throws 'NotSupportedError'
    // when accessing `transfer.items` (2017/7/12)
    try {
        // Get and normalize files if they exist.
        if (transfer.items && transfer.items.length) {
            files = Array.from(transfer.items)
                .map((item) => (item.kind === 'file' ? item.getAsFile() : null))
                .filter(exists => exists);
        }
        else if (transfer.files && transfer.files.length) {
            files = Array.from(transfer.files);
        }
    }
    catch (err) {
        if (transfer.files && transfer.files.length) {
            files = Array.from(transfer.files);
        }
    }
    // Determine the type of the data.
    const data = { files, fragment, html, node, rich, text };
    data.type = getTransferType(data);
    return data;
}
/**
 * Takes text input, checks whether contains embedded data
 * and returns object with original text +/- additional data
 *
 * @param {String} text
 * @return {Object}
 */
function getEmbeddedTypes(text) {
    const prefix = 'SLATE-DATA-EMBED::';
    if (text.substring(0, prefix.length) !== prefix) {
        return { TEXT: text };
    }
    // Attempt to parse, if fails then just standard text/plain
    // Otherwise, already had data embedded
    try {
        return JSON.parse(text.substring(prefix.length));
    }
    catch (err) {
        throw new Error('Unable to parse custom Slate drag event data.');
    }
}
/**
 * Get the type of a transfer from its `data`.
 *
 * @param {Object} data
 * @return {String}
 */
function getTransferType(data) {
    if (data.fragment)
        return 'fragment';
    if (data.node)
        return 'node';
    // COMPAT: Microsoft Word adds an image of the selected text to the data.
    // Since files are preferred over HTML or text, this would cause the type to
    // be considered `files`. But it also adds rich text data so we can check
    // for that and properly set the type to `html` or `text`. (2016/11/21)
    if (data.rich && data.html)
        return 'html';
    if (data.rich && data.text)
        return 'text';
    if (data.files && data.files.length)
        return 'files';
    if (data.html)
        return 'html';
    if (data.text)
        return 'text';
    return 'unknown';
}
/**
 * Get one of types `TYPES.FRAGMENT`, `TYPES.NODE`, `text/html`, `text/rtf` or
 * `text/plain` from transfers's `data` if possible, otherwise return null.
 *
 * @param {Object} transfer
 * @param {String} type
 * @return {String}
 */
function getType(transfer, type) {
    if (!transfer.types || !transfer.types.length) {
        // COMPAT: In IE 11, there is no `types` field but `getData('Text')`
        // is supported`. (2017/06/23)
        return type === TEXT ? transfer.getData('Text') || null : null;
    }
    // COMPAT: In Edge, transfer.types doesn't respond to `indexOf`. (2017/10/25)
    const types = Array.from(transfer.types);
    return types.indexOf(type) !== -1 ? transfer.getData(type) || null : null;
}
/**
 * Export.
 *
 * @type {Function}
 */
export default getEventTransfer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWV2ZW50LXRyYW5zZmVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5neC1zbGF0ZS9jb3JlLyIsInNvdXJjZXMiOlsidXRpbHMvZ2V0LWV2ZW50LXRyYW5zZmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sTUFBTSxNQUFNLHlCQUF5QixDQUFDO0FBQzdDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUU5QyxPQUFPLGNBQWMsTUFBTSw2QkFBNkIsQ0FBQztBQUN6RCxPQUFPLFVBQVUsTUFBTSw4QkFBOEIsQ0FBQztBQUV0RDs7OztHQUlHO0FBRUgsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxjQUFjLENBQUM7QUFFNUQ7Ozs7R0FJRztBQUVILE1BQU0sZ0JBQWdCLEdBQUcsa0NBQWtDLENBQUM7QUFFNUQ7Ozs7O0dBS0c7QUFFSCxTQUFTLGdCQUFnQixDQUFDLEtBQUs7SUFDM0IseURBQXlEO0lBQ3pELGtFQUFrRTtJQUNsRSxxQkFBcUI7SUFDckIsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFO1FBQzdCLEtBQUssR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO0tBQzdCO0lBRUQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFlBQVksSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDO0lBQzNELElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDM0MsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNuQyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDckMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNuQyxJQUFJLEtBQUssQ0FBQztJQUVWLDRFQUE0RTtJQUM1RSxnQ0FBZ0M7SUFDaEMsc0NBQXNDO0lBQ3RDLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLFVBQVUsQ0FBQyxRQUFRLElBQUksQ0FBQyxFQUFFO1FBQ2pFLE1BQU0sT0FBTyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLHFDQUFxQztRQUN0RSxJQUFJLE9BQU8sRUFBRTtZQUNULFFBQVEsR0FBRyxPQUFPLENBQUM7U0FDdEI7S0FDSjtJQUVELGdEQUFnRDtJQUNoRCxnRUFBZ0U7SUFDaEUsSUFBSSxJQUFJLEVBQUU7UUFDTixNQUFNLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QyxJQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUN6QixRQUFRLEdBQUcsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3RDO1FBQ0QsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckIsSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjtRQUNELElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3JCLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDOUI7S0FDSjtJQUVELDJDQUEyQztJQUMzQyxJQUFJLFFBQVEsRUFBRTtRQUNWLFFBQVEsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQy9DO0lBQ0QsSUFBSSxJQUFJLEVBQUU7UUFDTixJQUFJLEdBQUcsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUN2QztJQUVELG9EQUFvRDtJQUNwRCw4Q0FBOEM7SUFDOUMsSUFBSTtRQUNBLHlDQUF5QztRQUN6QyxJQUFJLFFBQVEsQ0FBQyxLQUFLLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDekMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztpQkFDN0IsR0FBRyxDQUFDLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNwRSxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNqQzthQUFNLElBQUksUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNoRCxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEM7S0FDSjtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1YsSUFBSSxRQUFRLENBQUMsS0FBSyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3pDLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN0QztLQUNKO0lBRUQsa0NBQWtDO0lBQ2xDLE1BQU0sSUFBSSxHQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUM5RCxJQUFJLENBQUMsSUFBSSxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQyxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBRUgsU0FBUyxnQkFBZ0IsQ0FBQyxJQUFJO0lBQzFCLE1BQU0sTUFBTSxHQUFHLG9CQUFvQixDQUFDO0lBRXBDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLE1BQU0sRUFBRTtRQUM3QyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO0tBQ3pCO0lBRUQsMkRBQTJEO0lBQzNELHVDQUF1QztJQUN2QyxJQUFJO1FBQ0EsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7S0FDcEQ7SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztLQUNwRTtBQUNMLENBQUM7QUFFRDs7Ozs7R0FLRztBQUVILFNBQVMsZUFBZSxDQUFDLElBQUk7SUFDekIsSUFBSSxJQUFJLENBQUMsUUFBUTtRQUFFLE9BQU8sVUFBVSxDQUFDO0lBQ3JDLElBQUksSUFBSSxDQUFDLElBQUk7UUFBRSxPQUFPLE1BQU0sQ0FBQztJQUU3Qix5RUFBeUU7SUFDekUsNEVBQTRFO0lBQzVFLHlFQUF5RTtJQUN6RSx1RUFBdUU7SUFDdkUsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJO1FBQUUsT0FBTyxNQUFNLENBQUM7SUFDMUMsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJO1FBQUUsT0FBTyxNQUFNLENBQUM7SUFFMUMsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTTtRQUFFLE9BQU8sT0FBTyxDQUFDO0lBQ3BELElBQUksSUFBSSxDQUFDLElBQUk7UUFBRSxPQUFPLE1BQU0sQ0FBQztJQUM3QixJQUFJLElBQUksQ0FBQyxJQUFJO1FBQUUsT0FBTyxNQUFNLENBQUM7SUFDN0IsT0FBTyxTQUFTLENBQUM7QUFDckIsQ0FBQztBQUVEOzs7Ozs7O0dBT0c7QUFFSCxTQUFTLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSTtJQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBQzNDLG9FQUFvRTtRQUNwRSw4QkFBOEI7UUFDOUIsT0FBTyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0tBQ2xFO0lBRUQsNkVBQTZFO0lBQzdFLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRXpDLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUM5RSxDQUFDO0FBRUQ7Ozs7R0FJRztBQUVILGVBQWUsZ0JBQWdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmFzZTY0IGZyb20gJ3NsYXRlLWJhc2U2NC1zZXJpYWxpemVyJztcbmltcG9ydCB7IElTX0lFIH0gZnJvbSAnc2xhdGUtZGV2LWVudmlyb25tZW50JztcblxuaW1wb3J0IFRSQU5TRkVSX1RZUEVTIGZyb20gJy4uL2NvbnN0YW50cy90cmFuc2Zlci10eXBlcyc7XG5pbXBvcnQgREFUQV9BVFRSUyBmcm9tICcuLi9jb25zdGFudHMvZGF0YS1hdHRyaWJ1dGVzJztcblxuLyoqXG4gKiBUcmFuc2ZlciB0eXBlcy5cbiAqXG4gKiBAdHlwZSB7U3RyaW5nfVxuICovXG5cbmNvbnN0IHsgRlJBR01FTlQsIEhUTUwsIE5PREUsIFJJQ0gsIFRFWFQgfSA9IFRSQU5TRkVSX1RZUEVTO1xuXG4vKipcbiAqIEZyYWdtZW50IG1hdGNoaW5nIHJlZ2V4cCBmb3IgSFRNTCBub2Rlcy5cbiAqXG4gKiBAdHlwZSB7UmVnRXhwfVxuICovXG5cbmNvbnN0IEZSQUdNRU5UX01BVENIRVIgPSAvIGRhdGEtc2xhdGUtZnJhZ21lbnQ9XCIoW15cXHNcIl0rKVwiLztcblxuLyoqXG4gKiBHZXQgdGhlIHRyYW5zZmVyIGRhdGEgZnJvbSBhbiBgZXZlbnRgLlxuICpcbiAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50XG4gKiBAcmV0dXJuIHtPYmplY3R9XG4gKi9cblxuZnVuY3Rpb24gZ2V0RXZlbnRUcmFuc2ZlcihldmVudCkge1xuICAgIC8vIENPTVBBVDogSUUgMTEgZG9lc24ndCBwb3B1bGF0ZSBuYXRpdmVFdmVudCB3aXRoIGVpdGhlclxuICAgIC8vIGRhdGFUcmFuc2ZlciBvciBjbGlwYm9hcmREYXRhLiBXZSdsbCBuZWVkIHRvIHVzZSB0aGUgYmFzZSBldmVudFxuICAgIC8vIG9iamVjdCAoMjAxOC8xNC82KVxuICAgIGlmICghSVNfSUUgJiYgZXZlbnQubmF0aXZlRXZlbnQpIHtcbiAgICAgICAgZXZlbnQgPSBldmVudC5uYXRpdmVFdmVudDtcbiAgICB9XG5cbiAgICBjb25zdCB0cmFuc2ZlciA9IGV2ZW50LmRhdGFUcmFuc2ZlciB8fCBldmVudC5jbGlwYm9hcmREYXRhO1xuICAgIGxldCBmcmFnbWVudCA9IGdldFR5cGUodHJhbnNmZXIsIEZSQUdNRU5UKTtcbiAgICBsZXQgbm9kZSA9IGdldFR5cGUodHJhbnNmZXIsIE5PREUpO1xuICAgIGNvbnN0IGh0bWwgPSBnZXRUeXBlKHRyYW5zZmVyLCBIVE1MKTtcbiAgICBjb25zdCByaWNoID0gZ2V0VHlwZSh0cmFuc2ZlciwgUklDSCk7XG4gICAgbGV0IHRleHQgPSBnZXRUeXBlKHRyYW5zZmVyLCBURVhUKTtcbiAgICBsZXQgZmlsZXM7XG5cbiAgICAvLyBJZiB0aGVyZSBpc24ndCBhIGZyYWdtZW50LCBidXQgdGhlcmUgaXMgSFRNTCwgY2hlY2sgdG8gc2VlIGlmIHRoZSBIVE1MIGlzXG4gICAgLy8gYWN0dWFsbHkgYW4gZW5jb2RlZCBmcmFnbWVudC5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYml0d2lzZVxuICAgIGlmICghZnJhZ21lbnQgJiYgaHRtbCAmJiB+aHRtbC5pbmRleE9mKGAgJHtEQVRBX0FUVFJTLkZSQUdNRU5UfT1cImApKSB7XG4gICAgICAgIGNvbnN0IG1hdGNoZXMgPSBGUkFHTUVOVF9NQVRDSEVSLmV4ZWMoaHRtbCk7XG4gICAgICAgIGNvbnN0IFtmdWxsLCBlbmNvZGVkXSA9IG1hdGNoZXM7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgICAgICAgaWYgKGVuY29kZWQpIHtcbiAgICAgICAgICAgIGZyYWdtZW50ID0gZW5jb2RlZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENPTVBBVDogRWRnZSBkb2Vzbid0IGhhbmRsZSBjdXN0b20gZGF0YSB0eXBlc1xuICAgIC8vIFRoZXNlIHdpbGwgYmUgZW1iZWRkZWQgaW4gdGV4dC9wbGFpbiBpbiB0aGlzIGNhc2UgKDIwMTcvNy8xMilcbiAgICBpZiAodGV4dCkge1xuICAgICAgICBjb25zdCBlbWJlZGRlZFR5cGVzID0gZ2V0RW1iZWRkZWRUeXBlcyh0ZXh0KTtcblxuICAgICAgICBpZiAoZW1iZWRkZWRUeXBlc1tGUkFHTUVOVF0pIHtcbiAgICAgICAgICAgIGZyYWdtZW50ID0gZW1iZWRkZWRUeXBlc1tGUkFHTUVOVF07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVtYmVkZGVkVHlwZXNbTk9ERV0pIHtcbiAgICAgICAgICAgIG5vZGUgPSBlbWJlZGRlZFR5cGVzW05PREVdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChlbWJlZGRlZFR5cGVzW1RFWFRdKSB7XG4gICAgICAgICAgICB0ZXh0ID0gZW1iZWRkZWRUeXBlc1tURVhUXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIERlY29kZSBhIGZyYWdtZW50IG9yIG5vZGUgaWYgdGhleSBleGlzdC5cbiAgICBpZiAoZnJhZ21lbnQpIHtcbiAgICAgICAgZnJhZ21lbnQgPSBCYXNlNjQuZGVzZXJpYWxpemVOb2RlKGZyYWdtZW50KTtcbiAgICB9XG4gICAgaWYgKG5vZGUpIHtcbiAgICAgICAgbm9kZSA9IEJhc2U2NC5kZXNlcmlhbGl6ZU5vZGUobm9kZSk7XG4gICAgfVxuXG4gICAgLy8gQ09NUEFUOiBFZGdlIHNvbWV0aW1lcyB0aHJvd3MgJ05vdFN1cHBvcnRlZEVycm9yJ1xuICAgIC8vIHdoZW4gYWNjZXNzaW5nIGB0cmFuc2Zlci5pdGVtc2AgKDIwMTcvNy8xMilcbiAgICB0cnkge1xuICAgICAgICAvLyBHZXQgYW5kIG5vcm1hbGl6ZSBmaWxlcyBpZiB0aGV5IGV4aXN0LlxuICAgICAgICBpZiAodHJhbnNmZXIuaXRlbXMgJiYgdHJhbnNmZXIuaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBmaWxlcyA9IEFycmF5LmZyb20odHJhbnNmZXIuaXRlbXMpXG4gICAgICAgICAgICAgICAgLm1hcCgoaXRlbTogYW55KSA9PiAoaXRlbS5raW5kID09PSAnZmlsZScgPyBpdGVtLmdldEFzRmlsZSgpIDogbnVsbCkpXG4gICAgICAgICAgICAgICAgLmZpbHRlcihleGlzdHMgPT4gZXhpc3RzKTtcbiAgICAgICAgfSBlbHNlIGlmICh0cmFuc2Zlci5maWxlcyAmJiB0cmFuc2Zlci5maWxlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZpbGVzID0gQXJyYXkuZnJvbSh0cmFuc2Zlci5maWxlcyk7XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKHRyYW5zZmVyLmZpbGVzICYmIHRyYW5zZmVyLmZpbGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgZmlsZXMgPSBBcnJheS5mcm9tKHRyYW5zZmVyLmZpbGVzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIERldGVybWluZSB0aGUgdHlwZSBvZiB0aGUgZGF0YS5cbiAgICBjb25zdCBkYXRhOiBhbnkgPSB7IGZpbGVzLCBmcmFnbWVudCwgaHRtbCwgbm9kZSwgcmljaCwgdGV4dCB9O1xuICAgIGRhdGEudHlwZSA9IGdldFRyYW5zZmVyVHlwZShkYXRhKTtcbiAgICByZXR1cm4gZGF0YTtcbn1cblxuLyoqXG4gKiBUYWtlcyB0ZXh0IGlucHV0LCBjaGVja3Mgd2hldGhlciBjb250YWlucyBlbWJlZGRlZCBkYXRhXG4gKiBhbmQgcmV0dXJucyBvYmplY3Qgd2l0aCBvcmlnaW5hbCB0ZXh0ICsvLSBhZGRpdGlvbmFsIGRhdGFcbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gdGV4dFxuICogQHJldHVybiB7T2JqZWN0fVxuICovXG5cbmZ1bmN0aW9uIGdldEVtYmVkZGVkVHlwZXModGV4dCkge1xuICAgIGNvbnN0IHByZWZpeCA9ICdTTEFURS1EQVRBLUVNQkVEOjonO1xuXG4gICAgaWYgKHRleHQuc3Vic3RyaW5nKDAsIHByZWZpeC5sZW5ndGgpICE9PSBwcmVmaXgpIHtcbiAgICAgICAgcmV0dXJuIHsgVEVYVDogdGV4dCB9O1xuICAgIH1cblxuICAgIC8vIEF0dGVtcHQgdG8gcGFyc2UsIGlmIGZhaWxzIHRoZW4ganVzdCBzdGFuZGFyZCB0ZXh0L3BsYWluXG4gICAgLy8gT3RoZXJ3aXNlLCBhbHJlYWR5IGhhZCBkYXRhIGVtYmVkZGVkXG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodGV4dC5zdWJzdHJpbmcocHJlZml4Lmxlbmd0aCkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBwYXJzZSBjdXN0b20gU2xhdGUgZHJhZyBldmVudCBkYXRhLicpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIHR5cGUgb2YgYSB0cmFuc2ZlciBmcm9tIGl0cyBgZGF0YWAuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRhdGFcbiAqIEByZXR1cm4ge1N0cmluZ31cbiAqL1xuXG5mdW5jdGlvbiBnZXRUcmFuc2ZlclR5cGUoZGF0YSkge1xuICAgIGlmIChkYXRhLmZyYWdtZW50KSByZXR1cm4gJ2ZyYWdtZW50JztcbiAgICBpZiAoZGF0YS5ub2RlKSByZXR1cm4gJ25vZGUnO1xuXG4gICAgLy8gQ09NUEFUOiBNaWNyb3NvZnQgV29yZCBhZGRzIGFuIGltYWdlIG9mIHRoZSBzZWxlY3RlZCB0ZXh0IHRvIHRoZSBkYXRhLlxuICAgIC8vIFNpbmNlIGZpbGVzIGFyZSBwcmVmZXJyZWQgb3ZlciBIVE1MIG9yIHRleHQsIHRoaXMgd291bGQgY2F1c2UgdGhlIHR5cGUgdG9cbiAgICAvLyBiZSBjb25zaWRlcmVkIGBmaWxlc2AuIEJ1dCBpdCBhbHNvIGFkZHMgcmljaCB0ZXh0IGRhdGEgc28gd2UgY2FuIGNoZWNrXG4gICAgLy8gZm9yIHRoYXQgYW5kIHByb3Blcmx5IHNldCB0aGUgdHlwZSB0byBgaHRtbGAgb3IgYHRleHRgLiAoMjAxNi8xMS8yMSlcbiAgICBpZiAoZGF0YS5yaWNoICYmIGRhdGEuaHRtbCkgcmV0dXJuICdodG1sJztcbiAgICBpZiAoZGF0YS5yaWNoICYmIGRhdGEudGV4dCkgcmV0dXJuICd0ZXh0JztcblxuICAgIGlmIChkYXRhLmZpbGVzICYmIGRhdGEuZmlsZXMubGVuZ3RoKSByZXR1cm4gJ2ZpbGVzJztcbiAgICBpZiAoZGF0YS5odG1sKSByZXR1cm4gJ2h0bWwnO1xuICAgIGlmIChkYXRhLnRleHQpIHJldHVybiAndGV4dCc7XG4gICAgcmV0dXJuICd1bmtub3duJztcbn1cblxuLyoqXG4gKiBHZXQgb25lIG9mIHR5cGVzIGBUWVBFUy5GUkFHTUVOVGAsIGBUWVBFUy5OT0RFYCwgYHRleHQvaHRtbGAsIGB0ZXh0L3J0ZmAgb3JcbiAqIGB0ZXh0L3BsYWluYCBmcm9tIHRyYW5zZmVycydzIGBkYXRhYCBpZiBwb3NzaWJsZSwgb3RoZXJ3aXNlIHJldHVybiBudWxsLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSB0cmFuc2ZlclxuICogQHBhcmFtIHtTdHJpbmd9IHR5cGVcbiAqIEByZXR1cm4ge1N0cmluZ31cbiAqL1xuXG5mdW5jdGlvbiBnZXRUeXBlKHRyYW5zZmVyLCB0eXBlKSB7XG4gICAgaWYgKCF0cmFuc2Zlci50eXBlcyB8fCAhdHJhbnNmZXIudHlwZXMubGVuZ3RoKSB7XG4gICAgICAgIC8vIENPTVBBVDogSW4gSUUgMTEsIHRoZXJlIGlzIG5vIGB0eXBlc2AgZmllbGQgYnV0IGBnZXREYXRhKCdUZXh0JylgXG4gICAgICAgIC8vIGlzIHN1cHBvcnRlZGAuICgyMDE3LzA2LzIzKVxuICAgICAgICByZXR1cm4gdHlwZSA9PT0gVEVYVCA/IHRyYW5zZmVyLmdldERhdGEoJ1RleHQnKSB8fCBudWxsIDogbnVsbDtcbiAgICB9XG5cbiAgICAvLyBDT01QQVQ6IEluIEVkZ2UsIHRyYW5zZmVyLnR5cGVzIGRvZXNuJ3QgcmVzcG9uZCB0byBgaW5kZXhPZmAuICgyMDE3LzEwLzI1KVxuICAgIGNvbnN0IHR5cGVzID0gQXJyYXkuZnJvbSh0cmFuc2Zlci50eXBlcyk7XG5cbiAgICByZXR1cm4gdHlwZXMuaW5kZXhPZih0eXBlKSAhPT0gLTEgPyB0cmFuc2Zlci5nZXREYXRhKHR5cGUpIHx8IG51bGwgOiBudWxsO1xufVxuXG4vKipcbiAqIEV4cG9ydC5cbiAqXG4gKiBAdHlwZSB7RnVuY3Rpb259XG4gKi9cblxuZXhwb3J0IGRlZmF1bHQgZ2V0RXZlbnRUcmFuc2ZlcjtcbiJdfQ==